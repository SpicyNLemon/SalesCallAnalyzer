<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Sales Call Analyzer</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='Icon.png') }}?v=999999">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <nav class="navbar navbar-dark navbar-brand">
    <div class="container-fluid">
    </div>
  </nav>

  <div class="container">
    <div class="header-section">
      <h1>Audio Emotion Recognition</h1>
      <p class="subtitle">Upload your sales call recordings and analyze the emotions expressed</p>
    </div>

      <!-- Speech Analysis Section -->
      <div class="card shadow-lg">
        <div class="card-header gradient-header">
          <h3 class="mb-0"><i class="bi bi-waveform"></i> Speech Analysis</h3>
        </div>
        <div class="card-body">
          <h5 class="mb-4">Upload an Audio File for Emotion Recognition</h5>
          <div class="file-upload-wrapper">
            <label for="audioFile" class="file-upload-label">
              <i class="bi bi-upload"></i> Choose Audio File
            </label>
            <input type="file" id="audioFile" accept=".wav, .mp3, .flac, .ogg, .m4a, .aac" onchange="showFileName()">
            <div id="fileName" class="file-name-display"></div>
          </div>
          <div class="button-wrapper">
            <button type="button" onclick="uploadAudio()" class="btn-upload">
              <i class="bi bi-play-circle-fill"></i> Upload & Analyze
            </button>
          </div>

          <!-- Loading Spinner -->
          <div id="loadingSpinner" class="loading-container" style="display: none;">
            <div class="spinner"></div>
            <p class="loading-text">Analyzing your audio... <br><small>Transcribing and predicting emotion</small></p>
          </div>

          <div id="audioResult" class="result-section" style="display: none;">
            <div class="result-header">
              <h3><i class="bi bi-check-circle-fill"></i> Analysis Results</h3>
            </div>
            
            <div class="predicted-emotion-box">
              <p class="emotion-label">Predicted Emotion</p>
              <p class="emotion-value"><span id="audioPrediction"></span></p>
            </div>
            
            <div class="top-emotions-section">
              <h5><i class="bi bi-graph-up-arrow"></i> Top 3 Emotions Detected</h5>
              <ul id="audioTop3" class="emotions-list"></ul>
            </div>
            
            <div class="transcript-section">
              <h5><i class="bi bi-chat-dots-fill"></i> Transcript</h5>
              <div id="audioTranscript" class="transcript-box"></div>
            </div>
          </div>
        </div>
      </div>
  <footer class="footer">
    <p>&copy; 2026 AI Sales Call Analyzer. All rights reserved.</p>
  </footer>

  <script>
    console.log("Script loaded successfully");
    
    function showFileName() {
      const input = document.getElementById("audioFile");
      const fileNameDisplay = document.getElementById("fileName");
      fileNameDisplay.textContent = input.files.length > 0 ? input.files[0].name : "";
    }

    function uploadAudio() {
      console.log("uploadAudio function called");
      
      const fileInput = document.getElementById("audioFile").files[0];
      if (!fileInput) {
        console.log("No file selected");
        alert("Please select an audio file.");
        return;
      }

      console.log("File selected:", fileInput.name);
      alert("File selected: " + fileInput.name + " - Processing started!");

      const formData = new FormData();
      formData.append("file", fileInput);

      // Show loading spinner
      const spinner = document.getElementById("loadingSpinner");
      const result = document.getElementById("audioResult");
      
      console.log("Showing spinner...");
      console.log("Spinner element:", spinner);
      spinner.style.display = "block";
      result.style.display = "none";
      console.log("Spinner display:", spinner.style.display);

      fetch("/upload_audio", {
        method: "POST",
        body: formData
      })
      .then(response => {
        console.log("Response received:", response.status);
        if (!response.ok) {
          throw new Error('Server error: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        console.log("Data received:", data);
        // Hide loading spinner
        document.getElementById("loadingSpinner").style.display = "none";

        if (data.error) {
          alert('Error: ' + data.error);
          return;
        }
        document.getElementById("audioResult").style.display = "block";
        document.getElementById("audioPrediction").innerText = data.prediction;
        document.getElementById("audioTranscript").innerText = data.transcript;

        // Display top 3 emotions
        const top3List = document.getElementById("audioTop3");
        top3List.innerHTML = "";
        for (let emotion in data.top_3) {
          const listItem = document.createElement("li");
          const percentage = data.top_3[emotion];
          listItem.innerHTML = `
            <div class="emotion-bar-container">
              <div class="emotion-percentage">
                ${percentage.toFixed(1)}%
              </div>
              <div class="progress" style="flex: 1;">
                <div class="progress-bar" role="progressbar" style="width: ${percentage}%;" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100">
                  ${emotion}
                </div>
              </div>
            </div>
          `;
          top3List.appendChild(listItem);
        }
      })
      .catch(error => {
        console.error("Error caught:", error);
        // Hide loading spinner on error
        document.getElementById("loadingSpinner").style.display = "none";
        alert('Upload failed: ' + error.message);
      });
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
